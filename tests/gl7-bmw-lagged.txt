# Godley and Lavoie (2007) Chapter 7: Model BMW
# Source: https://joaomacalos.github.io/sfcr/articles/articles/gl5-bmw.html
# Bank-Money World model - Version with explicit lagged variables

# Model BMW - Bank-Money World (Godley & Lavoie Chapter 7)
# Based on sfcr R package implementation
# Reference: Monetary Economics by Wynne Godley and Marc Lavoie, Chapter 7
#
# This version uses lag(x, 1) function to represent year-lagged variables
# matching the sfcr R package [-1] notation:
#   rl[-1] -> lag(rl, 1)
#   Ld[-1] -> lag(Ld, 1)
#   K[-1]  -> lag(K, 1)
#   etc.
#
# Available lag functions:
#   last(x)     - returns value from PREVIOUS TIMESTEP (very short lag)
#   lag(x, n)   - returns value from n TIME UNITS ago (e.g., 1 year)

#===============================================================================
# TEXT LABEL
#===============================================================================

@circuit
x 500 32 400 32 4 18 Godley\sand\sLavoie\s(2007)\sChapter\s7:\sModel\sBMW
x 500 56 400 56 4 12 Bank-Money\sWorld\smodel\s(with\sexplicit\slagged\svariables)
x 500 80 400 80 4 12 Steady-state:\sY=160,\sCs=144,\sIs=16,\sK=160,\sMh=160
@end

#===============================================================================
# INITIALIZATION
#===============================================================================

@init
  timestep: 0.01
  voltageUnit: $
  timeUnit: yr
@end

#===============================================================================
# PARAMETERS (Exogenous Variables)
# Reference: bmw_external in sfcr
#===============================================================================

@parameters Params
  rl = 0.025              # Interest rate on loans
  \alpha0 = 20            # Autonomous consumption
  \alpha1 = 0.75          # Propensity to consume from income
  \alpha2 = 0.10          # Propensity to consume from wealth
  \delta = 0.10           # Depreciation rate
  \gamma = 0.15           # Adjustment speed of capital to target
  \kappa = 1              # Capital-output ratio target
  pr = 1                  # Labor productivity
@end

#===============================================================================
# EQUATIONS - Basic behavioral equations (eq1-eq4)
# sfcr: Cs ~ Cd, Is ~ Id, Ns ~ Nd, Ls ~ Ls[-1] + Ld - Ld[-1]
#===============================================================================

@equations MarketClearing
  # Supply = Demand identities
  Cs ~ Cd                  # Consumption goods market clears
  Is ~ Id                  # Investment goods market clears
  Ns ~ Nd                  # Labor market clears
  
  # Loan supply tracks loan demand changes
  # sfcr: Ls ~ Ls[-1] + Ld - Ld[-1]
  Ls ~ integrate(diff(Ld))
@end

#===============================================================================
# EQUATIONS - Transactions of Firms (eq5-eq8)
# sfcr:
#   Y ~ Cs + Is
#   WBd ~ Y - rl[-1] * Ld[-1] - AF
#   AF ~ delta * K[-1]
#   Ld ~ Ld[-1] + Id - AF
#===============================================================================

@equations Firms
  # Total output = consumption + investment
  Y ~ Cs + Is
  
  # Wage bill demanded by firms (residual after interest and depreciation)
  # sfcr: WBd ~ Y - rl[-1] * Ld[-1] - AF
  # Interest on loans uses 1-YEAR LAGGED interest rate and loan balance
  WBd ~ Y - lag(rl, 1) * lag(Ld, 1) - AF
  
  # Amortization funds (depreciation)
  # sfcr: AF ~ delta * K[-1]
  # Based on 1-YEAR LAGGED capital stock
  AF ~ \delta * lag(K, 1)
  
  # Loan demand accumulates investment net of depreciation
  # sfcr: Ld ~ Ld[-1] + Id - AF
  Ld ~ integrate(Id - AF)
@end

#===============================================================================
# EQUATIONS - Transactions of Households (eq9-eq10)
# sfcr:
#   YD ~ WBs + rm[-1] * Mh[-1]
#   Mh ~ Mh[-1] + YD - Cd
#===============================================================================

@equations Households
  # Disposable income = wages + interest on deposits
  # sfcr: YD ~ WBs + rm[-1] * Mh[-1]
  # Interest income uses 1-YEAR LAGGED deposit rate and money holdings
  YD ~ WBs + lag(rm, 1) * lag(Mh, 1)
  
  # Money holdings accumulate savings (STOCK)
  # sfcr: Mh ~ Mh[-1] + YD - Cd
  Mh ~ Mh_init + integrate(YD - Cd)
@end

#===============================================================================
# EQUATIONS - Transactions of Banks (eq11-eq12)
# sfcr:
#   Ms ~ Ms[-1] + Ls - Ls[-1]
#   rm ~ rl
#===============================================================================

@equations Banks
  # Money supply tracks loan supply changes
  # sfcr: Ms ~ Ms[-1] + Ls - Ls[-1]
  Ms ~ integrate(diff(Ls))
  
  # Deposit rate = loan rate (simplified bank balance)
  # sfcr: rm ~ rl
  rm ~ rl
@end

#===============================================================================
# EQUATIONS - The Wage Bill (eq13-eq15)
# sfcr:
#   WBs ~ W * Ns
#   Nd ~ Y / pr
#   W ~ WBd / Nd
#===============================================================================

@equations WageBill
  # Wage bill supplied to households
  WBs ~ W * Ns
  
  # Labor demand based on output and productivity
  Nd ~ Y / pr
  
  # Wage rate (equilibrates wage bill)
  # Added max() to prevent division by zero
  W ~ WBd / max(Nd, 0.01)
@end

#===============================================================================
# EQUATIONS - Household Behavior (eq16)
# sfcr: Cd ~ alpha0 + alpha1 * YD + alpha2 * Mh[-1]
#===============================================================================

@equations Consumption
  # Consumption function with autonomous + income + wealth effects
  # sfcr: Cd ~ alpha0 + alpha1 * YD + alpha2 * Mh[-1]
  # Wealth effect uses 1-YEAR LAGGED money holdings
  Cd ~ \alpha0 + \alpha1 * YD + \alpha2 * lag(Mh, 1)
@end

#===============================================================================
# EQUATIONS - Investment Behavior (eq17-eq20)
# sfcr:
#   K ~ K[-1] + Id - DA
#   DA ~ delta * K[-1]
#   KT ~ kappa * Y[-1]
#   Id ~ gamma * (KT - K[-1]) + DA
#===============================================================================

@equations Investment
  # Capital stock accumulates investment (STOCK)
  # sfcr: K ~ K[-1] + Id - DA
  K ~ K_init + integrate(Id - DA)
  
  # Depreciation (actual)
  # sfcr: DA ~ delta * K[-1]
  # Based on 1-YEAR LAGGED capital stock
  DA ~ \delta * lag(K, 1)
  
  # Target capital stock based on output
  # sfcr: KT ~ kappa * Y[-1]
  # Based on 1-YEAR LAGGED output
  KT ~ \kappa * lag(Y, 1)
  
  # Investment to adjust capital toward target
  # sfcr: Id ~ gamma * (KT - K[-1]) + DA
  # Adjustment uses 1-YEAR LAGGED capital stock
  Id ~ \gamma * (KT - lag(K, 1)) + DA
@end

#===============================================================================
# VERIFICATION
#===============================================================================

@equations Verify
  # Accounting checks (should all be ~0)
  check_money ~ Mh - Ms            # Money market
  check_loans ~ Ls - Ld            # Loan market
  check_labor ~ Ns - Nd            # Labor market
  
  # Firm profit check (should be ~0)
  # Uses lagged values to match sfcr transaction matrix
  firm_profit ~ Y - WBd - lag(rl, 1) * lag(Ld, 1) - AF
@end

#===============================================================================
# HINTS
#===============================================================================

@hints
  Y: National income (output)
  Cs: Consumption supply
  Cd: Consumption demand
  Is: Investment supply
  Id: Investment demand
  Ns: Labor supply
  Nd: Labor demand
  Ls: Loan supply
  Ld: Loan demand
  WBs: Wage bill supplied
  WBd: Wage bill demanded
  W: Wage rate
  YD: Household disposable income = WBs + lag(rm,1) * lag(Mh,1)
  Mh: Household money holdings (deposits)
  Ms: Money supply (bank deposits)
  rm: Interest rate on deposits
  rl: Interest rate on loans
  K: Capital stock
  KT: Target capital stock = kappa * lag(Y,1)
  DA: Depreciation actual = delta * lag(K,1)
  AF: Amortization funds = delta * lag(K,1)
  \\alpha0: Autonomous consumption
  \\alpha1: Propensity to consume from income
  \\alpha2: Propensity to consume from wealth
  \\delta: Depreciation rate
  \\gamma: Investment adjustment speed
  \\kappa: Capital-output ratio
  pr: Labor productivity
@end

#===============================================================================
# SCOPES
#===============================================================================

@scope Y
@scope Cd
@scope Id
@scope K
@scope Mh
@scope Ld
@scope W
@scope check_money
@scope YD

#===============================================================================
# CIRCUIT ELEMENTS
#===============================================================================

@circuit
207 544 304 608 304 36 Y
403 544 320 896 512 0 9_4_0_xc01206_320_0.1_-1_1
@end

#===============================================================================
# SFCR R PACKAGE EQUATIONS - REFERENCE
#===============================================================================
# Source: https://joaomacalos.github.io/sfcr/articles/articles/gl5-bmw.html
#
# bmw_eqs <- sfcr_set(
#   # Basic behavioral equations
#   Cs ~ Cd,
#   Is ~ Id,
#   Ns ~ Nd,
#   Ls ~ Ls[-1] + Ld - Ld[-1],
#   
#   # Transactions of the firms
#   Y ~ Cs + Is,
#   WBd ~ Y - rl[-1] * Ld[-1] - AF,
#   AF ~ delta * K[-1],
#   Ld ~ Ld[-1] + Id - AF,
#   
#   # Transactions of households
#   YD ~ WBs + rm[-1] * Mh[-1],
#   Mh ~ Mh[-1] + YD - Cd,
#   
#   # Transactions of the banks
#   Ms ~ Ms[-1] + Ls - Ls[-1],
#   rm ~ rl,
#   
#   # The wage bill
#   WBs ~ W * Ns,
#   Nd ~ Y / pr,
#   W ~ WBd / Nd,
#   
#   # Household behavior
#   Cd ~ alpha0 + alpha1 * YD + alpha2 * Mh[-1],
#   
#   # The investment behavior
#   K ~ K[-1] + Id - DA,
#   DA ~ delta * K[-1],
#   KT ~ kappa * Y[-1],
#   Id ~ gamma * (KT - K[-1]) + DA
# )
#
# bmw_external <- sfcr_set(
#   rl ~ 0.025,
#   alpha0 ~ 20,
#   alpha1 ~ 0.75,
#   alpha2 ~ 0.10,
#   delta ~ 0.10,
#   gamma ~ 0.15,
#   kappa ~ 1,
#   pr ~ 1
# )
#===============================================================================

#===============================================================================
# EXPECTED STEADY-STATE VALUES - SFCR R Package Reference
#===============================================================================
# Source: sfcr R package - BMW model (Godley & Lavoie Chapter 7)
#
# Steady-state values (periods 31-50):
#
#   Y   = 160    (National income/output)
#   Cs  = 144    (Consumption supply)
#   Is  = 16     (Investment supply)
#   Ns  = 160    (Labor supply)
#   Ls  = 160    (Loan supply)
#   Ld  = 160    (Loan demand)
#   WBd = 140    (Wage bill demanded)
#   AF  = 16     (Amortization funds)
#   YD  = 144    (Disposable income)
#   Mh  = 160    (Household money)
#   Ms  = 160    (Money supply)
#   K   = 160    (Capital stock, since K/Y = kappa = 1)
#
# Key relationships at steady state:
#   - Y = Cs + Is = 144 + 16 = 160
#   - Id = DA = delta * K = 0.10 * 160 = 16 (investment = depreciation)
#   - YD = Cd = 144 (savings = 0)
#   - Mh = Ms = Ls = Ld = 160 (money = loans)
#   - K/Y = 160/160 = 1 = kappa (target achieved)
#
# Lagged variable relationships at steady state:
#   - YD = WBs + rm[-1] * Mh[-1] = 140 + 0.025 * 160 = 140 + 4 = 144
#   - WBd = Y - rl[-1] * Ld[-1] - AF = 160 - 0.025*160 - 16 = 160 - 4 - 16 = 140
#   - Interest income = rm * Mh = 0.025 * 160 = 4
#   - Interest expense = rl * Ld = 0.025 * 160 = 4
#
#===============================================================================
