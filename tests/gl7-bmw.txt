# Godley and Lavoie (2007) Chapter 7: Model BMW
# Source: vignettes/articles/gl5-bmw.Rmd
# Bank-Money World model

# Model BMW - Bank-Money World (Godley & Lavoie Chapter 7)
# Based on sfcr R package implementation
# Reference: Monetary Economics by Wynne Godley and Marc Lavoie, Chapter 7

#===============================================================================
# TEXT LABEL
#===============================================================================

@circuit
x 500 32 400 32 4 18 Godley\sand\sLavoie\s(2007)\sChapter\s7:\sModel\sBMW
x 500 56 400 56 4 12 Bank-Money\sWorld\smodel
x 500 80 400 80 4 12 Steady-state:\sY=160,\sCs=144,\sIs=16,\sK=160,\sMh=160
@end

#===============================================================================
# INITIALIZATION
#===============================================================================

@init
  timestep: 0.01
  voltageUnit: $
  timeUnit: yr
@end

#===============================================================================
# PARAMETERS (Exogenous Variables)
#===============================================================================

@parameters Params
  rl = 0.025              # Interest rate on loans
  \alpha0 = 20            # Autonomous consumption
  \alpha1 = 0.75          # Propensity to consume from income
  \alpha2 = 0.10          # Propensity to consume from wealth
  \delta = 0.10           # Depreciation rate
  \gamma = 0.15           # Adjustment speed of capital to target
  \kappa = 1              # Capital-output ratio target
  pr = 1                  # Labor productivity
@end



#===============================================================================
# EQUATIONS - Market Clearing (eq1-eq4)
#===============================================================================

@equations MarketClearing
  # Supply = Demand identities
  Cs ~ Cd                  # Consumption goods market clears
  Is ~ Id                  # Investment goods market clears
  Ns ~ Nd                  # Labor market clears
  
  # Loan supply tracks loan demand changes
  Ls ~ integrate(diff(Ld))
@end

#===============================================================================
# EQUATIONS - Firms (eq5-eq8)
#===============================================================================

@equations Firms
  # Total output = consumption + investment
  Y ~ Cs + Is
  
  # Wage bill demanded by firms (residual after interest and depreciation)
  WBd ~ Y - last(rl) * last(Ld) - AF
  
  # Amortization funds (depreciation)
  AF ~ \delta * last(K)
  
  # Loan demand accumulates investment net of depreciation
  Ld ~ integrate(Id - AF)
@end

#===============================================================================
# EQUATIONS - Households (eq9-eq10)
#===============================================================================

@equations Households
  # Disposable income = wages + interest on deposits
  YD ~ WBs + last(rm) * last(Mh)
  
  # Money holdings accumulate savings (STOCK)
  Mh ~ Mh_init + integrate(YD - Cd)
@end

#===============================================================================
# EQUATIONS - Banks (eq11-eq12)
#===============================================================================

@equations Banks
  # Money supply tracks loan supply changes
  Ms ~ integrate(diff(Ls))
  
  # Deposit rate = loan rate (simplified bank balance)
  rm ~ rl
@end

#===============================================================================
# EQUATIONS - Wage Bill (eq13-eq15)
#===============================================================================

@equations WageBill
  # Wage bill supplied to households
  WBs ~ W * Ns
  
  # Labor demand based on output and productivity
  Nd ~ Y / pr
  
  # Wage rate (equilibrates wage bill)
  W ~ WBd / max(Nd, 0.01)
@end

#===============================================================================
# EQUATIONS - Consumption (eq16)
#===============================================================================

@equations Consumption
  # Consumption function with autonomous + income + wealth effects
  Cd ~ \alpha0 + \alpha1 * YD + \alpha2 * last(Mh)
@end

#===============================================================================
# EQUATIONS - Investment (eq17-eq20)
#===============================================================================

@equations Investment
  # Capital stock accumulates investment (STOCK)
  K ~ K_init + integrate(Id - DA)
  
  # Depreciation (actual)
  DA ~ \delta * last(K)
  
  # Target capital stock based on output
  KT ~ \kappa * last(Y)
  
  # Investment to adjust capital toward target
  Id ~ \gamma * (KT - last(K)) + DA
@end

#===============================================================================
# VERIFICATION
#===============================================================================

@equations Verify
  # Accounting checks (should all be ~0)
  check_money ~ Mh - Ms            # Money market
  check_loans ~ Ls - Ld            # Loan market
  check_labor ~ Ns - Nd            # Labor market
  firm_profit ~ Y - WBd - rl * Ld - AF  # Firm profit (should be ~0)
@end

#===============================================================================
# HINTS
#===============================================================================

@hints
  Y: National income (output)
  Cs: Consumption supply
  Cd: Consumption demand
  Is: Investment supply
  Id: Investment demand
  Ns: Labor supply
  Nd: Labor demand
  Ls: Loan supply
  Ld: Loan demand
  WBs: Wage bill supplied
  WBd: Wage bill demanded
  W: Wage rate
  YD: Household disposable income
  Mh: Household money holdings (deposits)
  Ms: Money supply (bank deposits)
  rm: Interest rate on deposits
  rl: Interest rate on loans
  K: Capital stock
  KT: Target capital stock
  DA: Depreciation actual
  AF: Amortization funds
  \alpha0: Autonomous consumption
  \alpha1: Propensity to consume from income
  \alpha2: Propensity to consume from wealth
  \delta: Depreciation rate
  \gamma: Investment adjustment speed
  \kappa: Capital-output ratio
  pr: Labor productivity
@end

#===============================================================================
# SCOPES
#===============================================================================

@scope Y
@scope Cd
@scope Id
@scope K
@scope Mh
@scope Ld
@scope W
@scope check_money

#===============================================================================
# CIRCUIT ELEMENTS
#===============================================================================

@circuit
207 544 304 608 304 36 Y
403 544 320 896 512 0 9_4_0_xc01206_320_0.1_-1_1
@end

#===============================================================================
# EXPECTED STEADY-STATE VALUES - SFCR R Package Reference
#===============================================================================
# Source: sfcr R package - BMW model (Godley & Lavoie Chapter 7)
#
# Steady-state values (periods 31-50):
#
#   Y   = 160    (National income/output)
#   Cs  = 144    (Consumption supply)
#   Is  = 16     (Investment supply)
#   Ns  = 160    (Labor supply)
#   Ls  = 160    (Loan supply)
#   Ld  = 160    (Loan demand)
#   WBd = 140    (Wage bill demanded)
#   AF  = 16     (Amortization funds)
#   YD  = 144    (Disposable income)
#   Mh  = 160    (Household money)
#   Ms  = 160    (Money supply)
#   K   = 160    (Capital stock, since K/Y = kappa = 1)
#
# Key relationships at steady state:
#   - Y = Cs + Is = 144 + 16 = 160
#   - Id = DA = delta * K = 0.10 * 160 = 16 (investment = depreciation)
#   - YD = Cd = 144 (savings = 0)
#   - Mh = Ms = Ls = Ld = 160 (money = loans)
#   - K/Y = 160/160 = 1 = kappa (target achieved)
#
#===============================================================================



> bmw %>% tail(n = 20)
# A tibble: 20 Ã— 29
   period    Cs    Is    Ns    Ls     Y   WBd    AF    Ld    YD    Mh    Ms
    <int> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>
 1     31  144.  16.0  160.  160.  160.  140.  16.0  160.  144.  160.  160.
 2     32  144.  16.0  160.  160.  160.  140.  16.0  160.  144.  160.  160.
 3     33  144.  16.0  160.  160.  160.  140.  16.0  160.  144.  160.  160.
 4     34  144.  16.0  160.  160.  160.  140.  16.0  160.  144.  160.  160.
 5     35  144.  16.0  160.  160.  160.  140.  16.0  160.  144.  160.  160.
 6     36  144.  16.0  160.  160.  160.  140.  16.0  160.  144.  160.  160.
 7     37  144.  16.0  160.  160.  160.  140.  16.0  160.  144.  160.  160.
 8     38  144.  16.0  160.  160.  160.  140.  16.0  160.  144.  160.  160.
 9     39  144.  16.0  160.  160.  160.  140.  16.0  160.  144.  160.  160.
10     40  144.  16.0  160.  160.  160.  140.  16.0  160.  144.  160.  160.
11     41  144.  16.0  160.  160.  160.  140.  16.0  160.  144.  160.  160.
12     42  144.  16.0  160.  160.  160.  140.  16.0  160.  144.  160.  160.
13     43  144.  16.0  160.  160.  160.  140.  16.0  160.  144.  160.  160.
14     44  144.  16.0  160.  160.  160.  140.  16.0  160.  144.  160.  160.
15     45  144.  16.0  160.  160.  160.  140.  16.0  160.  144.  160.  160.
16     46  144.  16.0  160.  160.  160.  140.  16.0  160.  144.  160.  160.
17     47  144.  16.0  160.  160.  160.  140.  16.0  160.  144.  160.  160.
18     48  144.  16.0  160.  160.  160.  140.  16.0  160.  144.  160.  160.
19     49  144.  16.0  160.  160.  160.  140.  16.0  160.  144.  160.  160.
20     50  144.  16.0  160.  160.  160.  140.  16.0  160.  144.  160.  160.